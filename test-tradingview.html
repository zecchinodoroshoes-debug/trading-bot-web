<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test TradingView API</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border-left: 4px solid #007bff;
            background: #f9f9f9;
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .loading {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px 5px 5px 0;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: #007bff;
            color: white;
        }
        tr:hover {
            background: #f5f5f5;
        }
        .symbol-test {
            display: inline-block;
            margin: 5px;
            padding: 5px 10px;
            background: #e9ecef;
            border-radius: 4px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test TradingView API - Validazione Dati Reali</h1>
        
        <div class="test-section">
            <h2>Test Singolo Simbolo</h2>
            <input type="text" id="symbolInput" placeholder="Inserisci simbolo (es: NVDA)" value="NVDA" style="padding: 8px; width: 200px;">
            <button onclick="testSingleSymbol()">Test Simbolo</button>
            <div id="singleResult"></div>
        </div>

        <div class="test-section">
            <h2>Test Batch - 5 Simboli</h2>
            <button onclick="testBatch()">Test 5 Simboli</button>
            <div id="batchResult"></div>
        </div>

        <div class="test-section">
            <h2>Test Tutti i 23 Simboli</h2>
            <button onclick="testAllSymbols()">Test Tutti (23)</button>
            <div id="allResult"></div>
        </div>

        <div class="test-section">
            <h2>Risultati Dettagliati</h2>
            <table id="resultsTable" style="display: none;">
                <thead>
                    <tr>
                        <th>Simbolo</th>
                        <th>Prezzo</th>
                        <th>Cambio</th>
                        <th>% Cambio</th>
                        <th>Candele</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="resultsBody"></tbody>
            </table>
        </div>
    </div>

    <script src="tradingview-api.js"></script>
    <script>
        async function testSingleSymbol() {
            const symbol = document.getElementById('symbolInput').value.toUpperCase();
            if (!symbol) {
                alert('Inserisci un simbolo');
                return;
            }

            const resultDiv = document.getElementById('singleResult');
            resultDiv.innerHTML = '<div class="test-result loading">‚è≥ Recupero dati per ' + symbol + '...</div>';

            try {
                const data = await tradingViewAPI.fetchRealData(symbol);
                
                if (data) {
                    const html = `
                        <div class="test-result success">
                            <strong>‚úì Dati Reali Ricevuti</strong><br>
                            Simbolo: ${data.symbol}<br>
                            Prezzo: ${data.currentPrice}<br>
                            Cambio: ${data.change} (${data.changePercent}%)<br>
                            Candele: ${data.close.length}<br>
                            Fonte: Yahoo Finance (TradingView API)<br>
                            <strong>Ultimi 5 prezzi:</strong> ${data.close.slice(-5).map(p => p.toFixed(2)).join(', ')}
                        </div>
                    `;
                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = '<div class="test-result error">‚úó Errore: Dati non disponibili</div>';
                }
            } catch (error) {
                resultDiv.innerHTML = '<div class="test-result error">‚úó Errore: ' + error.message + '</div>';
            }
        }

        async function testBatch() {
            const symbols = ['NVDA', 'AAPL', 'MSFT', 'GOOGL', 'AMZN'];
            const resultDiv = document.getElementById('batchResult');
            resultDiv.innerHTML = '<div class="test-result loading">‚è≥ Test in corso...</div>';

            const results = [];
            for (const symbol of symbols) {
                try {
                    const data = await tradingViewAPI.fetchRealData(symbol);
                    results.push({
                        symbol,
                        success: !!data,
                        price: data?.currentPrice,
                        change: data?.changePercent,
                        candeles: data?.close.length
                    });
                } catch (error) {
                    results.push({
                        symbol,
                        success: false,
                        error: error.message
                    });
                }
                await new Promise(r => setTimeout(r, 300));
            }

            const successCount = results.filter(r => r.success).length;
            const html = `
                <div class="test-result success">
                    <strong>‚úì Test Completato: ${successCount}/${symbols.length} simboli</strong><br>
                    ${results.map(r => 
                        r.success 
                            ? `‚úì ${r.symbol}: ${r.price} (${r.change}%) - ${r.candeles} candele`
                            : `‚úó ${r.symbol}: ${r.error}`
                    ).join('<br>')}
                </div>
            `;
            resultDiv.innerHTML = html;
        }

        async function testAllSymbols() {
            const allSymbols = ['NVDA', 'ARM', 'GOOGL', 'META', 'AAPL', 'AMZN', 'MSFT', 'NFLX', 'TSLA', 'BABA',
                               'SPX', 'NDX', 'DAX', 'FTSE', 'AEX', 'EU50', 'HSI',
                               'NG', 'XAU', 'CL', 'XAG'];
            
            const resultDiv = document.getElementById('allResult');
            resultDiv.innerHTML = '<div class="test-result loading">‚è≥ Test di tutti i 23 simboli in corso...</div>';

            const results = [];
            let successCount = 0;

            for (let i = 0; i < allSymbols.length; i++) {
                const symbol = allSymbols[i];
                try {
                    const data = await tradingViewAPI.fetchRealData(symbol);
                    const success = !!data && data.close.length >= 20;
                    if (success) successCount++;
                    
                    results.push({
                        symbol,
                        success,
                        price: data?.currentPrice,
                        change: data?.changePercent,
                        candeles: data?.close.length
                    });
                } catch (error) {
                    results.push({
                        symbol,
                        success: false,
                        error: error.message
                    });
                }
                
                // Update progress
                resultDiv.innerHTML = `<div class="test-result loading">‚è≥ Progresso: ${i + 1}/${allSymbols.length} (${successCount} successi)</div>`;
                await new Promise(r => setTimeout(r, 300));
            }

            // Mostra risultati nella tabella
            const tbody = document.getElementById('resultsBody');
            tbody.innerHTML = results.map(r => `
                <tr>
                    <td><strong>${r.symbol}</strong></td>
                    <td>${r.price ? r.price.toFixed(2) : '-'}</td>
                    <td>${r.change ? r.change.toFixed(2) : '-'}</td>
                    <td>${r.change ? r.change.toFixed(2) + '%' : '-'}</td>
                    <td>${r.candeles || '-'}</td>
                    <td style="color: ${r.success ? 'green' : 'red'}; font-weight: bold;">
                        ${r.success ? '‚úì OK' : '‚úó ERRORE'}
                    </td>
                </tr>
            `).join('');
            document.getElementById('resultsTable').style.display = 'table';

            resultDiv.innerHTML = `
                <div class="test-result success">
                    <strong>‚úì Test Completato: ${successCount}/${allSymbols.length} simboli</strong><br>
                    Successo: ${Math.round(successCount/allSymbols.length*100)}%<br>
                    Vedi i dettagli nella tabella qui sotto.
                </div>
            `;
        }

        // Test automatico al caricamento
        window.addEventListener('load', () => {
            console.log('TradingView API Test Page Loaded');
            console.log('Versione API:', tradingViewAPI.constructor.name);
        });
    </script>
</body>
</html>
